# SPDX-FileCopyrightText: Copyright (c) 2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-Apache2
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


import numpy as np
from fw2nim.api_shim.api_triton_translation import arrays_to_pydantic, pydantic_to_arrays
from molmim_fw2nim.molmim_types import (
    MolMimControlOptIn,
    MolMimControlOptOut,
    MolMimEmbeddings,
    MolMimGenerated,
    MolMimHiddens,
    MolMimSequences,
)


#
# tests
#


def test_sequences():
    # covers input for embeddings/ and output for decode/
    payload: dict[str, list[str]] = {
        "sequences": ["CN1C=NC2=C1C(=O)N(C(=O)N2C)C", "CN1C=NC2=C1C(=O)N(C(=O)N2C)C"],
    }
    e2e_conversion_tester(MolMimSequences, payload)


def test_hiddens():
    # covers output for hidden/ and input for decode/
    payload = {
        # fmt: off
        "hiddens": [
            [
                0.3205399513244629,
                -0.6573460102081299,
                0.7227936387062073,
                0.1399211436510086,
                -0.35484328866004944,
                0.6630735993385315,
                -0.7272915244102478,
                -0.21027998626232147,
                0.21620126068592072,
                -1.1476964950561523,
                -1.08078932762146,
                -0.19573384523391724,
                -0.10431190580129623,
                0.30211907625198364,
                -0.17169862985610962,
                -0.4367547333240509,
                -0.6622852087020874,
                0.6061217188835144,
                -0.010021694004535675,
                0.2969902455806732,
                0.3776181638240814,
                0.020890889689326286,
                -0.21140031516551971,
                0.185404971241951,
                0.21987617015838623,
                0.23406659066677094,
                -0.20934903621673584,
                0.07757695764303207,
                -0.5913259983062744,
                0.47420892119407654,
                -0.2598778009414673,
                -0.34074005484580994,
                0.7345672845840454,
                -0.311099648475647,
                -0.007598048076033592,
                0.2100847065448761,
                -1.1400697231292725,
                -0.20824941992759705,
                -0.4424571096897125,
                -0.1311570107936859,
                -0.6119325757026672,
                -0.6863085627555847,
                -0.14619551599025726,
                -0.043900273740291595,
                0.184207484126091,
                -0.6997358202934265,
                0.7983806729316711,
                0.45029354095458984,
                -0.0022081290371716022,
                0.20500224828720093,
                -0.22508448362350464,
                0.40534496307373047,
                0.07269095629453659,
                0.006155205424875021,
                0.22235806286334991,
                -0.12428505718708038,
                -0.12489333748817444,
                0.019349677488207817,
                -0.13286210596561432,
                1.1007245779037476,
                0.4039968252182007,
                -0.85028076171875,
                -0.2847292423248291,
                0.1319015920162201,
                -0.3512742519378662,
                0.3694974184036255,
                -0.22903846204280853,
                -0.20141981542110443,
                0.5146613121032715,
                -0.23288507759571075,
                -0.39685285091400146,
                0.6745007634162903,
                -0.32666224241256714,
                0.529336154460907,
                -0.007667960599064827,
                0.2571702003479004,
                -0.015444698743522167,
                0.3690361976623535,
                0.6224445700645447,
                0.10930415242910385,
                -0.27545568346977234,
                0.4925536811351776,
                -0.05468704178929329,
                -0.7117582559585571,
                0.2357446253299713,
                -0.3430108428001404,
                0.37119343876838684,
                -0.0034453514963388443,
                -0.22086450457572937,
                -1.0234819650650024,
                0.12308599799871445,
                -0.6371954083442688,
                0.015573016367852688,
                0.6842058300971985,
                -0.4922318160533905,
                -0.15786711871623993,
                0.6639627814292908,
                -0.1700984090566635,
                -0.6454328894615173,
                0.469927579164505,
                -1.0138123035430908,
                -0.23237387835979462,
                -0.3110736906528473,
                -0.05864813178777695,
                -0.4037305414676666,
                -0.08705109357833862,
                0.6156903505325317,
                -0.4109117090702057,
                0.16055011749267578,
                0.4730406105518341,
                -0.47259634733200073,
                -0.24114780128002167,
                -0.8731306195259094,
                -0.22045235335826874,
                0.19758188724517822,
                0.18342898786067963,
                -0.07477667927742004,
                0.7583335638046265,
                -0.09208888560533524,
                0.11928565055131912,
                -0.24039433896541595,
                0.5404478311538696,
                -0.8052568435668945,
                0.5049884915351868,
                0.08292772620916367,
                0.13705791532993317,
                -0.48566463589668274,
                -0.5819650292396545,
                0.36021411418914795,
                -0.17489317059516907,
                0.47121864557266235,
                0.32070019841194153,
                0.11292003840208054,
                -0.3697834014892578,
                -0.7327578067779541,
                -0.12663425505161285,
                0.29077282547950745,
                -0.10692203044891357,
                -0.36559194326400757,
                0.04505544900894165,
                -0.4394836127758026,
                -0.7209623456001282,
                -0.49898773431777954,
                0.08352876454591751,
                -0.4814620912075043,
                -0.47720739245414734,
                -1.0233498811721802,
                -0.040743932127952576,
                -0.3557736873626709,
                0.33054113388061523,
                0.03870654106140137,
                -0.4089605212211609,
                0.004446844570338726,
                -0.19376827776432037,
                0.16056673228740692,
                0.2773376703262329,
                0.2727099657058716,
                -0.20521382987499237,
                0.3132270276546478,
                -0.4053483009338379,
                0.0008847865974530578,
                0.8782886862754822,
                -0.636951744556427,
                0.04199885204434395,
                -0.021405983716249466,
                0.0899767056107521,
                -0.017984075471758842,
                0.5815401077270508,
                -0.25879785418510437,
                0.5266948342323303,
                0.4818907678127289,
                -0.24508389830589294,
                0.03179693967103958,
                -0.15632124245166779,
                -0.26058074831962585,
                0.10631264746189117,
                0.13030612468719482,
                -0.23956258594989777,
                -0.470385879278183,
                1.2559090852737427,
                -0.07380542904138565,
                0.11814774572849274,
                0.6231937408447266,
                0.45831558108329773,
                -0.390451580286026,
                0.1157371923327446,
                -0.31185582280158997,
                -0.414156436920166,
                0.8621395230293274,
                0.4465934634208679,
                -0.2280883938074112,
                0.03333726525306702,
                0.5487525463104248,
                -0.621436595916748,
                -0.08321836590766907,
                -0.27853766083717346,
                0.43393388390541077,
                -0.20113225281238556,
                0.2815741300582886,
                -0.21322228014469147,
                -0.10784469544887543,
                -0.18250614404678345,
                0.32041460275650024,
                -0.7328569889068604,
                0.578048050403595,
                0.18977925181388855,
                -0.5956677198410034,
                0.35320815443992615,
                0.3846302926540375,
                -0.17284344136714935,
                -0.13586166501045227,
                0.006695857737213373,
                -0.1524256020784378,
                -0.5661515593528748,
                0.4534762501716614,
                -0.21068739891052246,
                0.30194875597953796,
                0.1482231616973877,
                0.7626008987426758,
                0.031092537567019463,
                0.22160863876342773,
                0.3557586967945099,
                0.5805391669273376,
                0.08958922326564789,
                0.44015464186668396,
                -0.2636882960796356,
                -0.09837557375431061,
                0.7051107287406921,
                0.19719311594963074,
                -0.622086763381958,
                0.06714967638254166,
                -0.24237817525863647,
                0.08219321072101593,
                0.4502963721752167,
                -0.11711997538805008,
                0.2682955861091614,
                0.3734804093837738,
                0.36822032928466797,
                -0.4718911647796631,
                0.798043966293335,
                0.1351853311061859,
                0.5574263334274292,
                0.4701575040817261,
                -0.4756815433502197,
                0.5849953889846802,
                1.3377903699874878,
                0.585546612739563,
                0.44349953532218933,
                0.5818243026733398,
                -0.6470195651054382,
                0.5644649863243103,
                -0.1695830374956131,
                -0.07076431810855865,
                -0.11726976186037064,
                -0.4756810665130615,
                -0.528954803943634,
                -0.011790035292506218,
                0.324264794588089,
                -0.46414944529533386,
                0.09247219562530518,
                -0.021390672773122787,
                -0.33468130230903625,
                -0.03938945382833481,
                -0.04537573456764221,
                0.02979191578924656,
                0.24321217834949493,
                -0.6526169776916504,
                -0.347125381231308,
                -0.0890417993068695,
                0.2593943476676941,
                0.7199395298957825,
                0.6096910834312439,
                -0.3149861991405487,
                0.464953750371933,
                0.06573691964149475,
                0.5964136123657227,
                0.7095900177955627,
                0.4681389033794403,
                -0.5848307609558105,
                -0.3682694137096405,
                -0.14408908784389496,
                -0.17994916439056396,
                -0.3821888566017151,
                -0.19923490285873413,
                -0.21665754914283752,
                0.27416881918907166,
                0.2813200056552887,
                -0.184078648686409,
                -0.014015045948326588,
                -0.04003417119383812,
                0.38657641410827637,
                -0.9751269817352295,
                0.5509824156761169,
                -0.398713082075119,
                -0.3153015077114105,
                -0.3484383225440979,
                0.6346685290336609,
                -0.20421847701072693,
                0.6921896934509277,
                0.7456946969032288,
                -0.2339574694633484,
                -0.6645746231079102,
                -0.11789342761039734,
                -0.5193966627120972,
                -0.07299921661615372,
                0.15766170620918274,
                -0.27810847759246826,
                -0.8441450595855713,
                0.8677797317504883,
                0.460231751203537,
                -0.546278178691864,
                -1.0346050262451172,
                -0.32202330231666565,
                0.07895935326814651,
                0.6487842798233032,
                0.1346878707408905,
                -0.428634375333786,
                0.15361399948596954,
                0.23897001147270203,
                -0.05467601493000984,
                -0.8958182334899902,
                -0.16375771164894104,
                0.21659548580646515,
                -0.21258287131786346,
                0.21241728961467743,
                0.2585156261920929,
                0.2850606441497803,
                0.315261572599411,
                -0.15660898387432098,
                -0.2933567464351654,
                0.4301533102989197,
                0.06335174292325974,
                -0.40724003314971924,
                0.18040762841701508,
                -0.4100826680660248,
                -0.7155072689056396,
                0.10441215336322784,
                -0.05613308772444725,
                0.0029274760745465755,
                -0.6970169544219971,
                -0.23129141330718994,
                -1.0135895013809204,
                0.2781316637992859,
                -0.17195652425289154,
                0.40074124932289124,
                -0.6106948256492615,
                -0.287275105714798,
                0.8345533609390259,
                -0.20803587138652802,
                -0.4296160042285919,
                -0.1690930873155594,
                -0.2983221411705017,
                0.32437610626220703,
                0.3991009294986725,
                -0.1021561324596405,
                -0.1051039770245552,
                -0.4765448570251465,
                0.23661476373672485,
                -0.02075093425810337,
                -0.7900695204734802,
                0.1565694361925125,
                0.49316200613975525,
                0.28267690539360046,
                0.07358410954475403,
                0.12052793800830841,
                0.5632713437080383,
                0.14803387224674225,
                -0.25401586294174194,
                -0.034662213176488876,
                -0.536820113658905,
                0.21485501527786255,
                0.04330312833189964,
                0.6379604339599609,
                -0.22994305193424225,
                0.27978575229644775,
                -0.0800679475069046,
                -0.4205629229545593,
                0.3467925488948822,
                0.7157770395278931,
                0.12842540442943573,
                -0.16790032386779785,
                0.3208633363246918,
                0.316095232963562,
                -0.6672564148902893,
                -0.2099742293357849,
                -0.5912964344024658,
                -0.15578259527683258,
                0.3095007836818695,
                -0.0054231309331953526,
                0.4443231523036957,
                -0.4214091897010803,
                -0.16687513887882233,
                0.08017729967832565,
                -0.060402676463127136,
                0.30949562788009644,
                -0.20624758303165436,
                0.6798767447471619,
                0.08496098220348358,
                0.6951578855514526,
                -0.2893080711364746,
                -0.5706223249435425,
                -0.13811111450195312,
                0.38858261704444885,
                0.16914920508861542,
                -0.13583894073963165,
                0.6099728345870972,
                0.08812056481838226,
                0.2720874845981598,
                0.07278891652822495,
                -0.2844185531139374,
                0.035813283175230026,
                -0.44867557287216187,
                -0.5179239511489868,
                0.13121221959590912,
                -0.09507091343402863,
                -0.0017367861000820994,
                -0.3700125515460968,
                0.3856548070907593,
                0.6109731197357178,
                0.14661109447479248,
                -0.06304199248552322,
                0.23099662363529205,
                0.25404930114746094,
                -0.45569878816604614,
                -0.0632397010922432,
                0.28311893343925476,
                0.24630333483219147,
                0.041543904691934586,
                0.08370637893676758,
                0.2126280814409256,
                0.06145432963967323,
                0.03875219449400902,
                -0.44920235872268677,
                0.13229911029338837,
                0.047132231295108795,
                0.13844704627990723,
                0.234111949801445,
                -0.8372974991798401,
                0.44064152240753174,
                0.39072510600090027,
                0.0002828239230439067,
                0.12916196882724762,
                0.21170200407505035,
                0.4902533292770386,
                0.4278180003166199,
                0.18014749884605408,
                -0.21845762431621552,
                0.08571979403495789,
                -0.12534989416599274,
                0.07433968037366867,
                -0.11248034238815308,
                -0.27013981342315674,
                -0.025124523788690567,
                0.22138291597366333,
                0.13240213692188263,
                -0.1987181156873703,
                -0.5192468166351318,
                -0.22918035089969635,
                -0.015589573420584202,
                0.009516635909676552,
                -0.24112649261951447,
                -0.046691037714481354,
                -0.7989354729652405,
                0.22179192304611206,
                -0.014235684648156166,
                -0.838004469871521,
                0.03303821384906769,
                -0.02216709777712822,
                0.9984990954399109,
                -0.16156555712223053,
                0.45724016427993774,
                -0.38978078961372375,
                0.10882553458213806,
                -0.5437644124031067,
                0.2577337324619293,
                -0.09031254798173904,
                -0.3983631730079651,
                -0.22828246653079987,
                0.30350080132484436,
                0.0968628078699112,
                -0.31409817934036255,
                0.035045329481363297,
                0.5366912484169006,
                -0.1551787555217743,
                -0.4438076615333557,
                1.2688366174697876,
                -0.12991110980510712,
                -0.24853478372097015,
                -0.4688313901424408,
                0.13769033551216125,
                0.4811535179615021,
                -0.13389407098293304,
                -0.2283049076795578,
                0.30738553404808044,
                0.8449376225471497,
                0.23181818425655365,
                0.12037937343120575,
                0.6120752096176147,
                -0.7421782612800598,
                -0.04998338595032692,
                0.19495491683483124,
                0.012986854650080204,
                0.4562614858150482,
                -0.028206197544932365,
                -0.42943063378334045,
                -0.06906677037477493,
                -0.35455766320228577,
                0.2753622829914093,
                -0.12625886499881744,
                0.15364931523799896,
                -0.3207167387008667,
                -0.13683949410915375,
            ],
            [
                0.3205399513244629,
                -0.6573460102081299,
                0.7227936387062073,
                0.1399211436510086,
                -0.35484328866004944,
                0.6630735993385315,
                -0.7272915244102478,
                -0.21027998626232147,
                0.21620126068592072,
                -1.1476964950561523,
                -1.08078932762146,
                -0.19573384523391724,
                -0.10431190580129623,
                0.30211907625198364,
                -0.17169862985610962,
                -0.4367547333240509,
                -0.6622852087020874,
                0.6061217188835144,
                -0.010021694004535675,
                0.2969902455806732,
                0.3776181638240814,
                0.020890889689326286,
                -0.21140031516551971,
                0.185404971241951,
                0.21987617015838623,
                0.23406659066677094,
                -0.20934903621673584,
                0.07757695764303207,
                -0.5913259983062744,
                0.47420892119407654,
                -0.2598778009414673,
                -0.34074005484580994,
                0.7345672845840454,
                -0.311099648475647,
                -0.007598048076033592,
                0.2100847065448761,
                -1.1400697231292725,
                -0.20824941992759705,
                -0.4424571096897125,
                -0.1311570107936859,
                -0.6119325757026672,
                -0.6863085627555847,
                -0.14619551599025726,
                -0.043900273740291595,
                0.184207484126091,
                -0.6997358202934265,
                0.7983806729316711,
                0.45029354095458984,
                -0.0022081290371716022,
                0.20500224828720093,
                -0.22508448362350464,
                0.40534496307373047,
                0.07269095629453659,
                0.006155205424875021,
                0.22235806286334991,
                -0.12428505718708038,
                -0.12489333748817444,
                0.019349677488207817,
                -0.13286210596561432,
                1.1007245779037476,
                0.4039968252182007,
                -0.85028076171875,
                -0.2847292423248291,
                0.1319015920162201,
                -0.3512742519378662,
                0.3694974184036255,
                -0.22903846204280853,
                -0.20141981542110443,
                0.5146613121032715,
                -0.23288507759571075,
                -0.39685285091400146,
                0.6745007634162903,
                -0.32666224241256714,
                0.529336154460907,
                -0.007667960599064827,
                0.2571702003479004,
                -0.015444698743522167,
                0.3690361976623535,
                0.6224445700645447,
                0.10930415242910385,
                -0.27545568346977234,
                0.4925536811351776,
                -0.05468704178929329,
                -0.7117582559585571,
                0.2357446253299713,
                -0.3430108428001404,
                0.37119343876838684,
                -0.0034453514963388443,
                -0.22086450457572937,
                -1.0234819650650024,
                0.12308599799871445,
                -0.6371954083442688,
                0.015573016367852688,
                0.6842058300971985,
                -0.4922318160533905,
                -0.15786711871623993,
                0.6639627814292908,
                -0.1700984090566635,
                -0.6454328894615173,
                0.469927579164505,
                -1.0138123035430908,
                -0.23237387835979462,
                -0.3110736906528473,
                -0.05864813178777695,
                -0.4037305414676666,
                -0.08705109357833862,
                0.6156903505325317,
                -0.4109117090702057,
                0.16055011749267578,
                0.4730406105518341,
                -0.47259634733200073,
                -0.24114780128002167,
                -0.8731306195259094,
                -0.22045235335826874,
                0.19758188724517822,
                0.18342898786067963,
                -0.07477667927742004,
                0.7583335638046265,
                -0.09208888560533524,
                0.11928565055131912,
                -0.24039433896541595,
                0.5404478311538696,
                -0.8052568435668945,
                0.5049884915351868,
                0.08292772620916367,
                0.13705791532993317,
                -0.48566463589668274,
                -0.5819650292396545,
                0.36021411418914795,
                -0.17489317059516907,
                0.47121864557266235,
                0.32070019841194153,
                0.11292003840208054,
                -0.3697834014892578,
                -0.7327578067779541,
                -0.12663425505161285,
                0.29077282547950745,
                -0.10692203044891357,
                -0.36559194326400757,
                0.04505544900894165,
                -0.4394836127758026,
                -0.7209623456001282,
                -0.49898773431777954,
                0.08352876454591751,
                -0.4814620912075043,
                -0.47720739245414734,
                -1.0233498811721802,
                -0.040743932127952576,
                -0.3557736873626709,
                0.33054113388061523,
                0.03870654106140137,
                -0.4089605212211609,
                0.004446844570338726,
                -0.19376827776432037,
                0.16056673228740692,
                0.2773376703262329,
                0.2727099657058716,
                -0.20521382987499237,
                0.3132270276546478,
                -0.4053483009338379,
                0.0008847865974530578,
                0.8782886862754822,
                -0.636951744556427,
                0.04199885204434395,
                -0.021405983716249466,
                0.0899767056107521,
                -0.017984075471758842,
                0.5815401077270508,
                -0.25879785418510437,
                0.5266948342323303,
                0.4818907678127289,
                -0.24508389830589294,
                0.03179693967103958,
                -0.15632124245166779,
                -0.26058074831962585,
                0.10631264746189117,
                0.13030612468719482,
                -0.23956258594989777,
                -0.470385879278183,
                1.2559090852737427,
                -0.07380542904138565,
                0.11814774572849274,
                0.6231937408447266,
                0.45831558108329773,
                -0.390451580286026,
                0.1157371923327446,
                -0.31185582280158997,
                -0.414156436920166,
                0.8621395230293274,
                0.4465934634208679,
                -0.2280883938074112,
                0.03333726525306702,
                0.5487525463104248,
                -0.621436595916748,
                -0.08321836590766907,
                -0.27853766083717346,
                0.43393388390541077,
                -0.20113225281238556,
                0.2815741300582886,
                -0.21322228014469147,
                -0.10784469544887543,
                -0.18250614404678345,
                0.32041460275650024,
                -0.7328569889068604,
                0.578048050403595,
                0.18977925181388855,
                -0.5956677198410034,
                0.35320815443992615,
                0.3846302926540375,
                -0.17284344136714935,
                -0.13586166501045227,
                0.006695857737213373,
                -0.1524256020784378,
                -0.5661515593528748,
                0.4534762501716614,
                -0.21068739891052246,
                0.30194875597953796,
                0.1482231616973877,
                0.7626008987426758,
                0.031092537567019463,
                0.22160863876342773,
                0.3557586967945099,
                0.5805391669273376,
                0.08958922326564789,
                0.44015464186668396,
                -0.2636882960796356,
                -0.09837557375431061,
                0.7051107287406921,
                0.19719311594963074,
                -0.622086763381958,
                0.06714967638254166,
                -0.24237817525863647,
                0.08219321072101593,
                0.4502963721752167,
                -0.11711997538805008,
                0.2682955861091614,
                0.3734804093837738,
                0.36822032928466797,
                -0.4718911647796631,
                0.798043966293335,
                0.1351853311061859,
                0.5574263334274292,
                0.4701575040817261,
                -0.4756815433502197,
                0.5849953889846802,
                1.3377903699874878,
                0.585546612739563,
                0.44349953532218933,
                0.5818243026733398,
                -0.6470195651054382,
                0.5644649863243103,
                -0.1695830374956131,
                -0.07076431810855865,
                -0.11726976186037064,
                -0.4756810665130615,
                -0.528954803943634,
                -0.011790035292506218,
                0.324264794588089,
                -0.46414944529533386,
                0.09247219562530518,
                -0.021390672773122787,
                -0.33468130230903625,
                -0.03938945382833481,
                -0.04537573456764221,
                0.02979191578924656,
                0.24321217834949493,
                -0.6526169776916504,
                -0.347125381231308,
                -0.0890417993068695,
                0.2593943476676941,
                0.7199395298957825,
                0.6096910834312439,
                -0.3149861991405487,
                0.464953750371933,
                0.06573691964149475,
                0.5964136123657227,
                0.7095900177955627,
                0.4681389033794403,
                -0.5848307609558105,
                -0.3682694137096405,
                -0.14408908784389496,
                -0.17994916439056396,
                -0.3821888566017151,
                -0.19923490285873413,
                -0.21665754914283752,
                0.27416881918907166,
                0.2813200056552887,
                -0.184078648686409,
                -0.014015045948326588,
                -0.04003417119383812,
                0.38657641410827637,
                -0.9751269817352295,
                0.5509824156761169,
                -0.398713082075119,
                -0.3153015077114105,
                -0.3484383225440979,
                0.6346685290336609,
                -0.20421847701072693,
                0.6921896934509277,
                0.7456946969032288,
                -0.2339574694633484,
                -0.6645746231079102,
                -0.11789342761039734,
                -0.5193966627120972,
                -0.07299921661615372,
                0.15766170620918274,
                -0.27810847759246826,
                -0.8441450595855713,
                0.8677797317504883,
                0.460231751203537,
                -0.546278178691864,
                -1.0346050262451172,
                -0.32202330231666565,
                0.07895935326814651,
                0.6487842798233032,
                0.1346878707408905,
                -0.428634375333786,
                0.15361399948596954,
                0.23897001147270203,
                -0.05467601493000984,
                -0.8958182334899902,
                -0.16375771164894104,
                0.21659548580646515,
                -0.21258287131786346,
                0.21241728961467743,
                0.2585156261920929,
                0.2850606441497803,
                0.315261572599411,
                -0.15660898387432098,
                -0.2933567464351654,
                0.4301533102989197,
                0.06335174292325974,
                -0.40724003314971924,
                0.18040762841701508,
                -0.4100826680660248,
                -0.7155072689056396,
                0.10441215336322784,
                -0.05613308772444725,
                0.0029274760745465755,
                -0.6970169544219971,
                -0.23129141330718994,
                -1.0135895013809204,
                0.2781316637992859,
                -0.17195652425289154,
                0.40074124932289124,
                -0.6106948256492615,
                -0.287275105714798,
                0.8345533609390259,
                -0.20803587138652802,
                -0.4296160042285919,
                -0.1690930873155594,
                -0.2983221411705017,
                0.32437610626220703,
                0.3991009294986725,
                -0.1021561324596405,
                -0.1051039770245552,
                -0.4765448570251465,
                0.23661476373672485,
                -0.02075093425810337,
                -0.7900695204734802,
                0.1565694361925125,
                0.49316200613975525,
                0.28267690539360046,
                0.07358410954475403,
                0.12052793800830841,
                0.5632713437080383,
                0.14803387224674225,
                -0.25401586294174194,
                -0.034662213176488876,
                -0.536820113658905,
                0.21485501527786255,
                0.04330312833189964,
                0.6379604339599609,
                -0.22994305193424225,
                0.27978575229644775,
                -0.0800679475069046,
                -0.4205629229545593,
                0.3467925488948822,
                0.7157770395278931,
                0.12842540442943573,
                -0.16790032386779785,
                0.3208633363246918,
                0.316095232963562,
                -0.6672564148902893,
                -0.2099742293357849,
                -0.5912964344024658,
                -0.15578259527683258,
                0.3095007836818695,
                -0.0054231309331953526,
                0.4443231523036957,
                -0.4214091897010803,
                -0.16687513887882233,
                0.08017729967832565,
                -0.060402676463127136,
                0.30949562788009644,
                -0.20624758303165436,
                0.6798767447471619,
                0.08496098220348358,
                0.6951578855514526,
                -0.2893080711364746,
                -0.5706223249435425,
                -0.13811111450195312,
                0.38858261704444885,
                0.16914920508861542,
                -0.13583894073963165,
                0.6099728345870972,
                0.08812056481838226,
                0.2720874845981598,
                0.07278891652822495,
                -0.2844185531139374,
                0.035813283175230026,
                -0.44867557287216187,
                -0.5179239511489868,
                0.13121221959590912,
                -0.09507091343402863,
                -0.0017367861000820994,
                -0.3700125515460968,
                0.3856548070907593,
                0.6109731197357178,
                0.14661109447479248,
                -0.06304199248552322,
                0.23099662363529205,
                0.25404930114746094,
                -0.45569878816604614,
                -0.0632397010922432,
                0.28311893343925476,
                0.24630333483219147,
                0.041543904691934586,
                0.08370637893676758,
                0.2126280814409256,
                0.06145432963967323,
                0.03875219449400902,
                -0.44920235872268677,
                0.13229911029338837,
                0.047132231295108795,
                0.13844704627990723,
                0.234111949801445,
                -0.8372974991798401,
                0.44064152240753174,
                0.39072510600090027,
                0.0002828239230439067,
                0.12916196882724762,
                0.21170200407505035,
                0.4902533292770386,
                0.4278180003166199,
                0.18014749884605408,
                -0.21845762431621552,
                0.08571979403495789,
                -0.12534989416599274,
                0.07433968037366867,
                -0.11248034238815308,
                -0.27013981342315674,
                -0.025124523788690567,
                0.22138291597366333,
                0.13240213692188263,
                -0.1987181156873703,
                -0.5192468166351318,
                -0.22918035089969635,
                -0.015589573420584202,
                0.009516635909676552,
                -0.24112649261951447,
                -0.046691037714481354,
                -0.7989354729652405,
                0.22179192304611206,
                -0.014235684648156166,
                -0.838004469871521,
                0.03303821384906769,
                -0.02216709777712822,
                0.9984990954399109,
                -0.16156555712223053,
                0.45724016427993774,
                -0.38978078961372375,
                0.10882553458213806,
                -0.5437644124031067,
                0.2577337324619293,
                -0.09031254798173904,
                -0.3983631730079651,
                -0.22828246653079987,
                0.30350080132484436,
                0.0968628078699112,
                -0.31409817934036255,
                0.035045329481363297,
                0.5366912484169006,
                -0.1551787555217743,
                -0.4438076615333557,
                1.2688366174697876,
                -0.12991110980510712,
                -0.24853478372097015,
                -0.4688313901424408,
                0.13769033551216125,
                0.4811535179615021,
                -0.13389407098293304,
                -0.2283049076795578,
                0.30738553404808044,
                0.8449376225471497,
                0.23181818425655365,
                0.12037937343120575,
                0.6120752096176147,
                -0.7421782612800598,
                -0.04998338595032692,
                0.19495491683483124,
                0.012986854650080204,
                0.4562614858150482,
                -0.028206197544932365,
                -0.42943063378334045,
                -0.06906677037477493,
                -0.35455766320228577,
                0.2753622829914093,
                -0.12625886499881744,
                0.15364931523799896,
                -0.3207167387008667,
                -0.13683949410915375,
            ],
        ],  # noqa
        "mask": [[True], [True]],
        # noqa
        # fmt: on
    }
    e2e_conversion_tester(MolMimHiddens, payload)


def test_embeddings():
    # covers output of embeddings/
    payload: dict[str, list[list[float]]] = {
        # fmt: off
        "embeddings": [
            [
                0.3205399513244629,
                -0.6573460102081299,
                0.7227936387062073,
                0.1399211436510086,
                -0.35484328866004944,
                0.6630735993385315,
                -0.7272915244102478,
                -0.21027998626232147,
                0.21620126068592072,
                -1.1476964950561523,
                -1.08078932762146,
                -0.19573384523391724,
                -0.10431190580129623,
                0.30211907625198364,
                -0.17169862985610962,
                -0.4367547333240509,
                -0.6622852087020874,
                0.6061217188835144,
                -0.010021694004535675,
                0.2969902455806732,
                0.3776181638240814,
                0.020890889689326286,
                -0.21140031516551971,
                0.185404971241951,
                0.21987617015838623,
                0.23406659066677094,
                -0.20934903621673584,
                0.07757695764303207,
                -0.5913259983062744,
                0.47420892119407654,
                -0.2598778009414673,
                -0.34074005484580994,
                0.7345672845840454,
                -0.311099648475647,
                -0.007598048076033592,
                0.2100847065448761,
                -1.1400697231292725,
                -0.20824941992759705,
                -0.4424571096897125,
                -0.1311570107936859,
                -0.6119325757026672,
                -0.6863085627555847,
                -0.14619551599025726,
                -0.043900273740291595,
                0.184207484126091,
                -0.6997358202934265,
                0.7983806729316711,
                0.45029354095458984,
                -0.0022081290371716022,
                0.20500224828720093,
                -0.22508448362350464,
                0.40534496307373047,
                0.07269095629453659,
                0.006155205424875021,
                0.22235806286334991,
                -0.12428505718708038,
                -0.12489333748817444,
                0.019349677488207817,
                -0.13286210596561432,
                1.1007245779037476,
                0.4039968252182007,
                -0.85028076171875,
                -0.2847292423248291,
                0.1319015920162201,
                -0.3512742519378662,
                0.3694974184036255,
                -0.22903846204280853,
                -0.20141981542110443,
                0.5146613121032715,
                -0.23288507759571075,
                -0.39685285091400146,
                0.6745007634162903,
                -0.32666224241256714,
                0.529336154460907,
                -0.007667960599064827,
                0.2571702003479004,
                -0.015444698743522167,
                0.3690361976623535,
                0.6224445700645447,
                0.10930415242910385,
                -0.27545568346977234,
                0.4925536811351776,
                -0.05468704178929329,
                -0.7117582559585571,
                0.2357446253299713,
                -0.3430108428001404,
                0.37119343876838684,
                -0.0034453514963388443,
                -0.22086450457572937,
                -1.0234819650650024,
                0.12308599799871445,
                -0.6371954083442688,
                0.015573016367852688,
                0.6842058300971985,
                -0.4922318160533905,
                -0.15786711871623993,
                0.6639627814292908,
                -0.1700984090566635,
                -0.6454328894615173,
                0.469927579164505,
                -1.0138123035430908,
                -0.23237387835979462,
                -0.3110736906528473,
                -0.05864813178777695,
                -0.4037305414676666,
                -0.08705109357833862,
                0.6156903505325317,
                -0.4109117090702057,
                0.16055011749267578,
                0.4730406105518341,
                -0.47259634733200073,
                -0.24114780128002167,
                -0.8731306195259094,
                -0.22045235335826874,
                0.19758188724517822,
                0.18342898786067963,
                -0.07477667927742004,
                0.7583335638046265,
                -0.09208888560533524,
                0.11928565055131912,
                -0.24039433896541595,
                0.5404478311538696,
                -0.8052568435668945,
                0.5049884915351868,
                0.08292772620916367,
                0.13705791532993317,
                -0.48566463589668274,
                -0.5819650292396545,
                0.36021411418914795,
                -0.17489317059516907,
                0.47121864557266235,
                0.32070019841194153,
                0.11292003840208054,
                -0.3697834014892578,
                -0.7327578067779541,
                -0.12663425505161285,
                0.29077282547950745,
                -0.10692203044891357,
                -0.36559194326400757,
                0.04505544900894165,
                -0.4394836127758026,
                -0.7209623456001282,
                -0.49898773431777954,
                0.08352876454591751,
                -0.4814620912075043,
                -0.47720739245414734,
                -1.0233498811721802,
                -0.040743932127952576,
                -0.3557736873626709,
                0.33054113388061523,
                0.03870654106140137,
                -0.4089605212211609,
                0.004446844570338726,
                -0.19376827776432037,
                0.16056673228740692,
                0.2773376703262329,
                0.2727099657058716,
                -0.20521382987499237,
                0.3132270276546478,
                -0.4053483009338379,
                0.0008847865974530578,
                0.8782886862754822,
                -0.636951744556427,
                0.04199885204434395,
                -0.021405983716249466,
                0.0899767056107521,
                -0.017984075471758842,
                0.5815401077270508,
                -0.25879785418510437,
                0.5266948342323303,
                0.4818907678127289,
                -0.24508389830589294,
                0.03179693967103958,
                -0.15632124245166779,
                -0.26058074831962585,
                0.10631264746189117,
                0.13030612468719482,
                -0.23956258594989777,
                -0.470385879278183,
                1.2559090852737427,
                -0.07380542904138565,
                0.11814774572849274,
                0.6231937408447266,
                0.45831558108329773,
                -0.390451580286026,
                0.1157371923327446,
                -0.31185582280158997,
                -0.414156436920166,
                0.8621395230293274,
                0.4465934634208679,
                -0.2280883938074112,
                0.03333726525306702,
                0.5487525463104248,
                -0.621436595916748,
                -0.08321836590766907,
                -0.27853766083717346,
                0.43393388390541077,
                -0.20113225281238556,
                0.2815741300582886,
                -0.21322228014469147,
                -0.10784469544887543,
                -0.18250614404678345,
                0.32041460275650024,
                -0.7328569889068604,
                0.578048050403595,
                0.18977925181388855,
                -0.5956677198410034,
                0.35320815443992615,
                0.3846302926540375,
                -0.17284344136714935,
                -0.13586166501045227,
                0.006695857737213373,
                -0.1524256020784378,
                -0.5661515593528748,
                0.4534762501716614,
                -0.21068739891052246,
                0.30194875597953796,
                0.1482231616973877,
                0.7626008987426758,
                0.031092537567019463,
                0.22160863876342773,
                0.3557586967945099,
                0.5805391669273376,
                0.08958922326564789,
                0.44015464186668396,
                -0.2636882960796356,
                -0.09837557375431061,
                0.7051107287406921,
                0.19719311594963074,
                -0.622086763381958,
                0.06714967638254166,
                -0.24237817525863647,
                0.08219321072101593,
                0.4502963721752167,
                -0.11711997538805008,
                0.2682955861091614,
                0.3734804093837738,
                0.36822032928466797,
                -0.4718911647796631,
                0.798043966293335,
                0.1351853311061859,
                0.5574263334274292,
                0.4701575040817261,
                -0.4756815433502197,
                0.5849953889846802,
                1.3377903699874878,
                0.585546612739563,
                0.44349953532218933,
                0.5818243026733398,
                -0.6470195651054382,
                0.5644649863243103,
                -0.1695830374956131,
                -0.07076431810855865,
                -0.11726976186037064,
                -0.4756810665130615,
                -0.528954803943634,
                -0.011790035292506218,
                0.324264794588089,
                -0.46414944529533386,
                0.09247219562530518,
                -0.021390672773122787,
                -0.33468130230903625,
                -0.03938945382833481,
                -0.04537573456764221,
                0.02979191578924656,
                0.24321217834949493,
                -0.6526169776916504,
                -0.347125381231308,
                -0.0890417993068695,
                0.2593943476676941,
                0.7199395298957825,
                0.6096910834312439,
                -0.3149861991405487,
                0.464953750371933,
                0.06573691964149475,
                0.5964136123657227,
                0.7095900177955627,
                0.4681389033794403,
                -0.5848307609558105,
                -0.3682694137096405,
                -0.14408908784389496,
                -0.17994916439056396,
                -0.3821888566017151,
                -0.19923490285873413,
                -0.21665754914283752,
                0.27416881918907166,
                0.2813200056552887,
                -0.184078648686409,
                -0.014015045948326588,
                -0.04003417119383812,
                0.38657641410827637,
                -0.9751269817352295,
                0.5509824156761169,
                -0.398713082075119,
                -0.3153015077114105,
                -0.3484383225440979,
                0.6346685290336609,
                -0.20421847701072693,
                0.6921896934509277,
                0.7456946969032288,
                -0.2339574694633484,
                -0.6645746231079102,
                -0.11789342761039734,
                -0.5193966627120972,
                -0.07299921661615372,
                0.15766170620918274,
                -0.27810847759246826,
                -0.8441450595855713,
                0.8677797317504883,
                0.460231751203537,
                -0.546278178691864,
                -1.0346050262451172,
                -0.32202330231666565,
                0.07895935326814651,
                0.6487842798233032,
                0.1346878707408905,
                -0.428634375333786,
                0.15361399948596954,
                0.23897001147270203,
                -0.05467601493000984,
                -0.8958182334899902,
                -0.16375771164894104,
                0.21659548580646515,
                -0.21258287131786346,
                0.21241728961467743,
                0.2585156261920929,
                0.2850606441497803,
                0.315261572599411,
                -0.15660898387432098,
                -0.2933567464351654,
                0.4301533102989197,
                0.06335174292325974,
                -0.40724003314971924,
                0.18040762841701508,
                -0.4100826680660248,
                -0.7155072689056396,
                0.10441215336322784,
                -0.05613308772444725,
                0.0029274760745465755,
                -0.6970169544219971,
                -0.23129141330718994,
                -1.0135895013809204,
                0.2781316637992859,
                -0.17195652425289154,
                0.40074124932289124,
                -0.6106948256492615,
                -0.287275105714798,
                0.8345533609390259,
                -0.20803587138652802,
                -0.4296160042285919,
                -0.1690930873155594,
                -0.2983221411705017,
                0.32437610626220703,
                0.3991009294986725,
                -0.1021561324596405,
                -0.1051039770245552,
                -0.4765448570251465,
                0.23661476373672485,
                -0.02075093425810337,
                -0.7900695204734802,
                0.1565694361925125,
                0.49316200613975525,
                0.28267690539360046,
                0.07358410954475403,
                0.12052793800830841,
                0.5632713437080383,
                0.14803387224674225,
                -0.25401586294174194,
                -0.034662213176488876,
                -0.536820113658905,
                0.21485501527786255,
                0.04330312833189964,
                0.6379604339599609,
                -0.22994305193424225,
                0.27978575229644775,
                -0.0800679475069046,
                -0.4205629229545593,
                0.3467925488948822,
                0.7157770395278931,
                0.12842540442943573,
                -0.16790032386779785,
                0.3208633363246918,
                0.316095232963562,
                -0.6672564148902893,
                -0.2099742293357849,
                -0.5912964344024658,
                -0.15578259527683258,
                0.3095007836818695,
                -0.0054231309331953526,
                0.4443231523036957,
                -0.4214091897010803,
                -0.16687513887882233,
                0.08017729967832565,
                -0.060402676463127136,
                0.30949562788009644,
                -0.20624758303165436,
                0.6798767447471619,
                0.08496098220348358,
                0.6951578855514526,
                -0.2893080711364746,
                -0.5706223249435425,
                -0.13811111450195312,
                0.38858261704444885,
                0.16914920508861542,
                -0.13583894073963165,
                0.6099728345870972,
                0.08812056481838226,
                0.2720874845981598,
                0.07278891652822495,
                -0.2844185531139374,
                0.035813283175230026,
                -0.44867557287216187,
                -0.5179239511489868,
                0.13121221959590912,
                -0.09507091343402863,
                -0.0017367861000820994,
                -0.3700125515460968,
                0.3856548070907593,
                0.6109731197357178,
                0.14661109447479248,
                -0.06304199248552322,
                0.23099662363529205,
                0.25404930114746094,
                -0.45569878816604614,
                -0.0632397010922432,
                0.28311893343925476,
                0.24630333483219147,
                0.041543904691934586,
                0.08370637893676758,
                0.2126280814409256,
                0.06145432963967323,
                0.03875219449400902,
                -0.44920235872268677,
                0.13229911029338837,
                0.047132231295108795,
                0.13844704627990723,
                0.234111949801445,
                -0.8372974991798401,
                0.44064152240753174,
                0.39072510600090027,
                0.0002828239230439067,
                0.12916196882724762,
                0.21170200407505035,
                0.4902533292770386,
                0.4278180003166199,
                0.18014749884605408,
                -0.21845762431621552,
                0.08571979403495789,
                -0.12534989416599274,
                0.07433968037366867,
                -0.11248034238815308,
                -0.27013981342315674,
                -0.025124523788690567,
                0.22138291597366333,
                0.13240213692188263,
                -0.1987181156873703,
                -0.5192468166351318,
                -0.22918035089969635,
                -0.015589573420584202,
                0.009516635909676552,
                -0.24112649261951447,
                -0.046691037714481354,
                -0.7989354729652405,
                0.22179192304611206,
                -0.014235684648156166,
                -0.838004469871521,
                0.03303821384906769,
                -0.02216709777712822,
                0.9984990954399109,
                -0.16156555712223053,
                0.45724016427993774,
                -0.38978078961372375,
                0.10882553458213806,
                -0.5437644124031067,
                0.2577337324619293,
                -0.09031254798173904,
                -0.3983631730079651,
                -0.22828246653079987,
                0.30350080132484436,
                0.0968628078699112,
                -0.31409817934036255,
                0.035045329481363297,
                0.5366912484169006,
                -0.1551787555217743,
                -0.4438076615333557,
                1.2688366174697876,
                -0.12991110980510712,
                -0.24853478372097015,
                -0.4688313901424408,
                0.13769033551216125,
                0.4811535179615021,
                -0.13389407098293304,
                -0.2283049076795578,
                0.30738553404808044,
                0.8449376225471497,
                0.23181818425655365,
                0.12037937343120575,
                0.6120752096176147,
                -0.7421782612800598,
                -0.04998338595032692,
                0.19495491683483124,
                0.012986854650080204,
                0.4562614858150482,
                -0.028206197544932365,
                -0.42943063378334045,
                -0.06906677037477493,
                -0.35455766320228577,
                0.2753622829914093,
                -0.12625886499881744,
                0.15364931523799896,
                -0.3207167387008667,
                -0.13683949410915375,
            ],
            [
                0.3205399513244629,
                -0.6573460102081299,
                0.7227936387062073,
                0.1399211436510086,
                -0.35484328866004944,
                0.6630735993385315,
                -0.7272915244102478,
                -0.21027998626232147,
                0.21620126068592072,
                -1.1476964950561523,
                -1.08078932762146,
                -0.19573384523391724,
                -0.10431190580129623,
                0.30211907625198364,
                -0.17169862985610962,
                -0.4367547333240509,
                -0.6622852087020874,
                0.6061217188835144,
                -0.010021694004535675,
                0.2969902455806732,
                0.3776181638240814,
                0.020890889689326286,
                -0.21140031516551971,
                0.185404971241951,
                0.21987617015838623,
                0.23406659066677094,
                -0.20934903621673584,
                0.07757695764303207,
                -0.5913259983062744,
                0.47420892119407654,
                -0.2598778009414673,
                -0.34074005484580994,
                0.7345672845840454,
                -0.311099648475647,
                -0.007598048076033592,
                0.2100847065448761,
                -1.1400697231292725,
                -0.20824941992759705,
                -0.4424571096897125,
                -0.1311570107936859,
                -0.6119325757026672,
                -0.6863085627555847,
                -0.14619551599025726,
                -0.043900273740291595,
                0.184207484126091,
                -0.6997358202934265,
                0.7983806729316711,
                0.45029354095458984,
                -0.0022081290371716022,
                0.20500224828720093,
                -0.22508448362350464,
                0.40534496307373047,
                0.07269095629453659,
                0.006155205424875021,
                0.22235806286334991,
                -0.12428505718708038,
                -0.12489333748817444,
                0.019349677488207817,
                -0.13286210596561432,
                1.1007245779037476,
                0.4039968252182007,
                -0.85028076171875,
                -0.2847292423248291,
                0.1319015920162201,
                -0.3512742519378662,
                0.3694974184036255,
                -0.22903846204280853,
                -0.20141981542110443,
                0.5146613121032715,
                -0.23288507759571075,
                -0.39685285091400146,
                0.6745007634162903,
                -0.32666224241256714,
                0.529336154460907,
                -0.007667960599064827,
                0.2571702003479004,
                -0.015444698743522167,
                0.3690361976623535,
                0.6224445700645447,
                0.10930415242910385,
                -0.27545568346977234,
                0.4925536811351776,
                -0.05468704178929329,
                -0.7117582559585571,
                0.2357446253299713,
                -0.3430108428001404,
                0.37119343876838684,
                -0.0034453514963388443,
                -0.22086450457572937,
                -1.0234819650650024,
                0.12308599799871445,
                -0.6371954083442688,
                0.015573016367852688,
                0.6842058300971985,
                -0.4922318160533905,
                -0.15786711871623993,
                0.6639627814292908,
                -0.1700984090566635,
                -0.6454328894615173,
                0.469927579164505,
                -1.0138123035430908,
                -0.23237387835979462,
                -0.3110736906528473,
                -0.05864813178777695,
                -0.4037305414676666,
                -0.08705109357833862,
                0.6156903505325317,
                -0.4109117090702057,
                0.16055011749267578,
                0.4730406105518341,
                -0.47259634733200073,
                -0.24114780128002167,
                -0.8731306195259094,
                -0.22045235335826874,
                0.19758188724517822,
                0.18342898786067963,
                -0.07477667927742004,
                0.7583335638046265,
                -0.09208888560533524,
                0.11928565055131912,
                -0.24039433896541595,
                0.5404478311538696,
                -0.8052568435668945,
                0.5049884915351868,
                0.08292772620916367,
                0.13705791532993317,
                -0.48566463589668274,
                -0.5819650292396545,
                0.36021411418914795,
                -0.17489317059516907,
                0.47121864557266235,
                0.32070019841194153,
                0.11292003840208054,
                -0.3697834014892578,
                -0.7327578067779541,
                -0.12663425505161285,
                0.29077282547950745,
                -0.10692203044891357,
                -0.36559194326400757,
                0.04505544900894165,
                -0.4394836127758026,
                -0.7209623456001282,
                -0.49898773431777954,
                0.08352876454591751,
                -0.4814620912075043,
                -0.47720739245414734,
                -1.0233498811721802,
                -0.040743932127952576,
                -0.3557736873626709,
                0.33054113388061523,
                0.03870654106140137,
                -0.4089605212211609,
                0.004446844570338726,
                -0.19376827776432037,
                0.16056673228740692,
                0.2773376703262329,
                0.2727099657058716,
                -0.20521382987499237,
                0.3132270276546478,
                -0.4053483009338379,
                0.0008847865974530578,
                0.8782886862754822,
                -0.636951744556427,
                0.04199885204434395,
                -0.021405983716249466,
                0.0899767056107521,
                -0.017984075471758842,
                0.5815401077270508,
                -0.25879785418510437,
                0.5266948342323303,
                0.4818907678127289,
                -0.24508389830589294,
                0.03179693967103958,
                -0.15632124245166779,
                -0.26058074831962585,
                0.10631264746189117,
                0.13030612468719482,
                -0.23956258594989777,
                -0.470385879278183,
                1.2559090852737427,
                -0.07380542904138565,
                0.11814774572849274,
                0.6231937408447266,
                0.45831558108329773,
                -0.390451580286026,
                0.1157371923327446,
                -0.31185582280158997,
                -0.414156436920166,
                0.8621395230293274,
                0.4465934634208679,
                -0.2280883938074112,
                0.03333726525306702,
                0.5487525463104248,
                -0.621436595916748,
                -0.08321836590766907,
                -0.27853766083717346,
                0.43393388390541077,
                -0.20113225281238556,
                0.2815741300582886,
                -0.21322228014469147,
                -0.10784469544887543,
                -0.18250614404678345,
                0.32041460275650024,
                -0.7328569889068604,
                0.578048050403595,
                0.18977925181388855,
                -0.5956677198410034,
                0.35320815443992615,
                0.3846302926540375,
                -0.17284344136714935,
                -0.13586166501045227,
                0.006695857737213373,
                -0.1524256020784378,
                -0.5661515593528748,
                0.4534762501716614,
                -0.21068739891052246,
                0.30194875597953796,
                0.1482231616973877,
                0.7626008987426758,
                0.031092537567019463,
                0.22160863876342773,
                0.3557586967945099,
                0.5805391669273376,
                0.08958922326564789,
                0.44015464186668396,
                -0.2636882960796356,
                -0.09837557375431061,
                0.7051107287406921,
                0.19719311594963074,
                -0.622086763381958,
                0.06714967638254166,
                -0.24237817525863647,
                0.08219321072101593,
                0.4502963721752167,
                -0.11711997538805008,
                0.2682955861091614,
                0.3734804093837738,
                0.36822032928466797,
                -0.4718911647796631,
                0.798043966293335,
                0.1351853311061859,
                0.5574263334274292,
                0.4701575040817261,
                -0.4756815433502197,
                0.5849953889846802,
                1.3377903699874878,
                0.585546612739563,
                0.44349953532218933,
                0.5818243026733398,
                -0.6470195651054382,
                0.5644649863243103,
                -0.1695830374956131,
                -0.07076431810855865,
                -0.11726976186037064,
                -0.4756810665130615,
                -0.528954803943634,
                -0.011790035292506218,
                0.324264794588089,
                -0.46414944529533386,
                0.09247219562530518,
                -0.021390672773122787,
                -0.33468130230903625,
                -0.03938945382833481,
                -0.04537573456764221,
                0.02979191578924656,
                0.24321217834949493,
                -0.6526169776916504,
                -0.347125381231308,
                -0.0890417993068695,
                0.2593943476676941,
                0.7199395298957825,
                0.6096910834312439,
                -0.3149861991405487,
                0.464953750371933,
                0.06573691964149475,
                0.5964136123657227,
                0.7095900177955627,
                0.4681389033794403,
                -0.5848307609558105,
                -0.3682694137096405,
                -0.14408908784389496,
                -0.17994916439056396,
                -0.3821888566017151,
                -0.19923490285873413,
                -0.21665754914283752,
                0.27416881918907166,
                0.2813200056552887,
                -0.184078648686409,
                -0.014015045948326588,
                -0.04003417119383812,
                0.38657641410827637,
                -0.9751269817352295,
                0.5509824156761169,
                -0.398713082075119,
                -0.3153015077114105,
                -0.3484383225440979,
                0.6346685290336609,
                -0.20421847701072693,
                0.6921896934509277,
                0.7456946969032288,
                -0.2339574694633484,
                -0.6645746231079102,
                -0.11789342761039734,
                -0.5193966627120972,
                -0.07299921661615372,
                0.15766170620918274,
                -0.27810847759246826,
                -0.8441450595855713,
                0.8677797317504883,
                0.460231751203537,
                -0.546278178691864,
                -1.0346050262451172,
                -0.32202330231666565,
                0.07895935326814651,
                0.6487842798233032,
                0.1346878707408905,
                -0.428634375333786,
                0.15361399948596954,
                0.23897001147270203,
                -0.05467601493000984,
                -0.8958182334899902,
                -0.16375771164894104,
                0.21659548580646515,
                -0.21258287131786346,
                0.21241728961467743,
                0.2585156261920929,
                0.2850606441497803,
                0.315261572599411,
                -0.15660898387432098,
                -0.2933567464351654,
                0.4301533102989197,
                0.06335174292325974,
                -0.40724003314971924,
                0.18040762841701508,
                -0.4100826680660248,
                -0.7155072689056396,
                0.10441215336322784,
                -0.05613308772444725,
                0.0029274760745465755,
                -0.6970169544219971,
                -0.23129141330718994,
                -1.0135895013809204,
                0.2781316637992859,
                -0.17195652425289154,
                0.40074124932289124,
                -0.6106948256492615,
                -0.287275105714798,
                0.8345533609390259,
                -0.20803587138652802,
                -0.4296160042285919,
                -0.1690930873155594,
                -0.2983221411705017,
                0.32437610626220703,
                0.3991009294986725,
                -0.1021561324596405,
                -0.1051039770245552,
                -0.4765448570251465,
                0.23661476373672485,
                -0.02075093425810337,
                -0.7900695204734802,
                0.1565694361925125,
                0.49316200613975525,
                0.28267690539360046,
                0.07358410954475403,
                0.12052793800830841,
                0.5632713437080383,
                0.14803387224674225,
                -0.25401586294174194,
                -0.034662213176488876,
                -0.536820113658905,
                0.21485501527786255,
                0.04330312833189964,
                0.6379604339599609,
                -0.22994305193424225,
                0.27978575229644775,
                -0.0800679475069046,
                -0.4205629229545593,
                0.3467925488948822,
                0.7157770395278931,
                0.12842540442943573,
                -0.16790032386779785,
                0.3208633363246918,
                0.316095232963562,
                -0.6672564148902893,
                -0.2099742293357849,
                -0.5912964344024658,
                -0.15578259527683258,
                0.3095007836818695,
                -0.0054231309331953526,
                0.4443231523036957,
                -0.4214091897010803,
                -0.16687513887882233,
                0.08017729967832565,
                -0.060402676463127136,
                0.30949562788009644,
                -0.20624758303165436,
                0.6798767447471619,
                0.08496098220348358,
                0.6951578855514526,
                -0.2893080711364746,
                -0.5706223249435425,
                -0.13811111450195312,
                0.38858261704444885,
                0.16914920508861542,
                -0.13583894073963165,
                0.6099728345870972,
                0.08812056481838226,
                0.2720874845981598,
                0.07278891652822495,
                -0.2844185531139374,
                0.035813283175230026,
                -0.44867557287216187,
                -0.5179239511489868,
                0.13121221959590912,
                -0.09507091343402863,
                -0.0017367861000820994,
                -0.3700125515460968,
                0.3856548070907593,
                0.6109731197357178,
                0.14661109447479248,
                -0.06304199248552322,
                0.23099662363529205,
                0.25404930114746094,
                -0.45569878816604614,
                -0.0632397010922432,
                0.28311893343925476,
                0.24630333483219147,
                0.041543904691934586,
                0.08370637893676758,
                0.2126280814409256,
                0.06145432963967323,
                0.03875219449400902,
                -0.44920235872268677,
                0.13229911029338837,
                0.047132231295108795,
                0.13844704627990723,
                0.234111949801445,
                -0.8372974991798401,
                0.44064152240753174,
                0.39072510600090027,
                0.0002828239230439067,
                0.12916196882724762,
                0.21170200407505035,
                0.4902533292770386,
                0.4278180003166199,
                0.18014749884605408,
                -0.21845762431621552,
                0.08571979403495789,
                -0.12534989416599274,
                0.07433968037366867,
                -0.11248034238815308,
                -0.27013981342315674,
                -0.025124523788690567,
                0.22138291597366333,
                0.13240213692188263,
                -0.1987181156873703,
                -0.5192468166351318,
                -0.22918035089969635,
                -0.015589573420584202,
                0.009516635909676552,
                -0.24112649261951447,
                -0.046691037714481354,
                -0.7989354729652405,
                0.22179192304611206,
                -0.014235684648156166,
                -0.838004469871521,
                0.03303821384906769,
                -0.02216709777712822,
                0.9984990954399109,
                -0.16156555712223053,
                0.45724016427993774,
                -0.38978078961372375,
                0.10882553458213806,
                -0.5437644124031067,
                0.2577337324619293,
                -0.09031254798173904,
                -0.3983631730079651,
                -0.22828246653079987,
                0.30350080132484436,
                0.0968628078699112,
                -0.31409817934036255,
                0.035045329481363297,
                0.5366912484169006,
                -0.1551787555217743,
                -0.4438076615333557,
                1.2688366174697876,
                -0.12991110980510712,
                -0.24853478372097015,
                -0.4688313901424408,
                0.13769033551216125,
                0.4811535179615021,
                -0.13389407098293304,
                -0.2283049076795578,
                0.30738553404808044,
                0.8449376225471497,
                0.23181818425655365,
                0.12037937343120575,
                0.6120752096176147,
                -0.7421782612800598,
                -0.04998338595032692,
                0.19495491683483124,
                0.012986854650080204,
                0.4562614858150482,
                -0.028206197544932365,
                -0.42943063378334045,
                -0.06906677037477493,
                -0.35455766320228577,
                0.2753622829914093,
                -0.12625886499881744,
                0.15364931523799896,
                -0.3207167387008667,
                -0.13683949410915375,
            ],
        ]
        # fmt: on
    }
    e2e_conversion_tester(MolMimEmbeddings, payload)


def test_sampling():
    # covers output of sampling/
    payload = {
        "generated": [
            "CN1C[C@H](C2=CSC(=O)N([C@@H](CCc3ccccc3)C(F)F)C2=O)CC1=O",
            "CN1C=NC2=C1C(=O)N(C(=O)c1ccccc1N1CCCCC1)C2",
        ]
    }
    e2e_conversion_tester(MolMimGenerated, payload)


def test_generate_input():
    # covers input of generate/
    payload = {
        "smi": "CN1C=NC2=C1C(=O)N(C(=O)N2C)C",
        "algorithm": "CMA-ES",
        "num_molecules": 5,
        "property_name": "plogP",
        "minimize": True,
        "min_similarity": 0.1,
        "particles": 8,
        "iterations": 10,
        "radius": 1.0,
    }
    e2e_conversion_tester(MolMimControlOptIn, payload)


def test_generate_output():
    # covers output of generate/
    payload = {
        "samples": [
            "CN1CCN(S(=O)(=O)N2CC[C@H]3CCCC[C@@H]3C2)c2ccccc21",
            "CN1C=CC2=C1C(=O)N(CC(=O)NC(C)(C)c1cccc(S(N)(=O)=O)c1)C2=O",
            "CN1N=CC2=C1C(=O)N1CC3(CCCC3)C[C@@H]1c1ccccc12",
            "CN1CC=C2[C@]1(C(=O)N1CC[C@]3(CCCCC(=O)N3)C1)CCN2C",
            "CCN1C=C2[C@]3(C(=O)OCC(=O)N(C)C(=O)N=C3C(=O)N2CCCCCCCO1",
        ],
        "scores": [0.09024570882320404, -0.9318130016326904, -3.364551067352295, -6.784757137298584, -100.0],
        "score_type": "c",
    }
    e2e_conversion_tester(MolMimControlOptOut, payload)


#
# helpers
#


def e2e_conversion_tester(pydantic_type, payload, *, verbose: bool = False) -> tuple:
    original = pydantic_type.model_validate(payload)

    converted = pydantic_to_arrays(original)
    if verbose:
        for n, c in converted.items():
            print(f"name: {n}")
            print(f"data:  {c.shape=} | {c.dtype=} | {str(c)[0:50]}..")
            print("-----------------------------------------------")

    reconstructed = arrays_to_pydantic(pydantic_type, converted)

    if verbose:
        print(f"{(original == reconstructed)=}")

    assert is_equal(original, reconstructed)

    return original, reconstructed, converted


def is_equal(pydantic_instance_1, pydantic_instance_2) -> bool:
    # exact equals! no isinstance !!
    assert type(pydantic_instance_1) == type(pydantic_instance_2)  # noqa
    if pydantic_instance_1 == pydantic_instance_2:
        return True
    else:
        # maybe numerical tolerance?
        attributes_1 = dict(pydantic_instance_1)
        attributes_2 = dict(pydantic_instance_2)

        assert len(attributes_1) == len(attributes_2)
        assert set(attributes_1.keys()) == set(attributes_2.keys())
        for n in attributes_1.keys():
            value_1 = attributes_1[n]
            value_2 = attributes_2[n]
            if value_1 != value_2:
                # check numerical tolerance!
                if isinstance(value_1, float) and isinstance(value_2, float):
                    if not np.isclose(value_1, value_2, atol=1e-3):
                        return False
                else:
                    return False
        return True
