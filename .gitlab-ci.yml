---
default:
  image: docker:20.10.16
  tags:
    - kamino-prod

stages:
  - build
  - test

services:
  - docker:20.10.16-dind

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  DOCKER_TLS_VERIFY: 1
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: "gitlab-master.nvidia.com:5005/clara-discovery/bionemo"


build-and-push:
  stage: build
  before_script:
    - until docker info; do sleep 1; done
    - mkdir -p $HOME/.docker
    - echo $DOCKER_AUTH_CONFIG > $HOME/.docker/config.json
  script: -|
    docker build --network host --ssh default --no-cache \
    -t "$IMAGE_TAG:$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" \
    -t "$IMAGE_TAG:$CI_COMMIT_SHA" \
    -f setup/Dockerfile-CI-Only .
    docker push $IMAGE_TAG --all-tags

.test-image:
  variables:
    MODEL_PATH: $CI_PROJECT_DIR/models
  stage: test
  script: -|
    docker run --rm \
    --network host \
    --gpus all \
    --shm-size=1g \
    --ulimit memlock=-1 \
    --ulimit stack=67108864 \
    -v ${CI_PROJECT_DIR}:/workspace/bionemo \
    -v ${MODEL_PATH}:/model \
    --env HOME=/workspace/bionemo \
    --env PYTHONPATH='/workspace/bionemo:/workspace/bionemo/generated:' \
    -w /workspace/bionemo \
    --name bionemo \
    ${IMAGE_TAG} pytest
